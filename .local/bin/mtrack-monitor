#!/bin/bash
# M-Track auto-switch monitor for Pulse/Pipewire with stream migration

LOGFILE="$HOME/.local/share/mtrack-monitor.log"
STATEFILE="$HOME/.local/share/mtrack-monitor.state"
mkdir -p "$(dirname "$LOGFILE")"

# Configuration
DEVICE_NAME="M-Track 8X4M"
CHECK_INTERVAL=5
DEBOUNCE_TIME=3
# Control recording stream migration behavior
# Set to true to automatically move recording streams (microphone, voice chat) to M-Track input
# Set to false (default) to preserve user's manually selected input device
MIGRATE_RECORDING_STREAMS=false

echo "$(date): M-Track monitor started" >> "$LOGFILE"

# Function to get current default sink ID
get_default_sink_id() {
    wpctl status | grep -A 50 "Sinks:" | grep -E "^\s*│\s*\*" | head -1 | sed -n 's/.*[[:space:]]\([0-9]\+\)\. .*/\1/p'
}

# Function to get current default source ID
get_default_source_id() {
    wpctl status | grep -A 50 "Sources:" | grep -E "^\s*│\s*\*" | head -1 | sed -n 's/.*[[:space:]]\([0-9]\+\)\. .*/\1/p'
}

# Function to get M-Track sink and source IDs
get_mtrack_ids() {
    local sink_id=$(wpctl status | grep -A 50 "Sinks:" | grep "$DEVICE_NAME.*Surround 4\.0" | sed -n 's/.*[[:space:]]\([0-9]\+\)\. .*/\1/p' | head -1)
    local source_id=$(wpctl status | grep -A 50 "Sources:" | grep "$DEVICE_NAME.*Surround 7\.1" | sed -n 's/.*[[:space:]]\([0-9]\+\)\. .*/\1/p' | head -1)

    echo "$sink_id $source_id"
}

# Function to check if M-Track is currently the default
# NOTE: Only checks output device (sink) - input device switching was removed
# to preserve user's preferred microphone/input device
is_mtrack_default() {
    local current_sink=$(get_default_sink_id)
    local mtrack_ids=($(get_mtrack_ids))
    local mtrack_sink=${mtrack_ids[0]}

    [[ -n "$mtrack_sink" && "$current_sink" == "$mtrack_sink" ]]
}

# Function to get all active sink inputs (playing streams)
get_active_sink_inputs() {
    wpctl status | grep -A 50 "Sink inputs:" | grep -E "^\s*[0-9]+" | sed -n 's/^[[:space:]]*\([0-9]*\).*/\1/p'
}

# Function to get all active source outputs (recording streams)
get_active_source_outputs() {
    wpctl status | grep -A 50 "Source outputs:" | grep -E "^\s*[0-9]+" | sed -n 's/^[[:space:]]*\([0-9]*\).*/\1/p'
}

# Function to check if there are active audio streams
has_active_streams() {
    local sink_inputs=$(get_active_sink_inputs | wc -l)
    local source_outputs=$(get_active_source_outputs | wc -l)
    [[ $sink_inputs -gt 0 || $source_outputs -gt 0 ]]
}

# Function to attempt gentle pipewire recovery before restart
attempt_pipewire_recovery() {
    local max_attempts=3
    local attempt=1

    echo "$(date): M-Track USB connected but audio not detected, attempting recovery..." >> "$LOGFILE"

    # Step 1: Extended wait period for device enumeration (10-15 seconds)
    echo "$(date): Waiting 30 seconds for M-Track audio device enumeration..." >> "$LOGFILE"
    sleep 30

    # Check if devices appeared after extended wait
    local mtrack_ids_wait=($(get_mtrack_ids))
    if [[ -n "${mtrack_ids_wait[0]}" ]]; then
        echo "$(date): M-Track audio detected after extended wait" >> "$LOGFILE"
        return 0
    fi

    # Step 2: Try refreshing wpctl status and reloading modules
    echo "$(date): Attempting gentle recovery methods..." >> "$LOGFILE"

    # Refresh wpctl status
    wpctl status > /dev/null 2>&1
    sleep 2

    # Try reloading specific modules if possible
    if systemctl --user is-active --quiet pipewire; then
        echo "$(date): Attempting module reload via systemctl reload-or-restart..." >> "$LOGFILE"
        systemctl --user reload-or-restart pipewire 2>/dev/null
        sleep 5

        local mtrack_ids_reload=($(get_mtrack_ids))
        if [[ -n "${mtrack_ids_reload[0]}" ]]; then
            echo "$(date): M-Track audio detected after module reload" >> "$LOGFILE"
            return 0
        fi
    fi

    # Step 3: Check for active streams before considering restart
    if has_active_streams; then
        echo "$(date): WARNING: Active audio streams detected - avoiding PipeWire restart" >> "$LOGFILE"
        echo "$(date): Active streams found, skipping restart to preserve audio playback" >> "$LOGFILE"
        return 1
    fi

    # Step 4: Last resort - full restart with multiple attempts
    while [[ $attempt -le $max_attempts ]]; do
        echo "$(date): Attempt $attempt/$max_attempts: Full PipeWire restart required (no active streams detected)" >> "$LOGFILE"

        systemctl --user restart pipewire
        sleep 8  # Longer wait after restart

        local mtrack_ids_restart=($(get_mtrack_ids))
        if [[ -n "${mtrack_ids_restart[0]}" ]]; then
            echo "$(date): M-Track audio detected after PipeWire restart (attempt $attempt)" >> "$LOGFILE"
            return 0
        fi

        ((attempt++))
        if [[ $attempt -le $max_attempts ]]; then
            echo "$(date): Restart attempt $((attempt-1)) failed, waiting before retry..." >> "$LOGFILE"
            sleep 5
        fi
    done

    echo "$(date): ERROR: M-Track audio still not available after $max_attempts restart attempts" >> "$LOGFILE"
    return 1
}

# Function to move all streams to M-Track
move_streams_to_mtrack() {
    local mtrack_ids=($(get_mtrack_ids))
    local mtrack_sink=${mtrack_ids[0]}
    local mtrack_source=${mtrack_ids[1]}

    if [[ -z "$mtrack_sink" ]]; then
        echo "$(date): ERROR: Cannot find M-Track sink for stream migration" >> "$LOGFILE"
        return 1
    fi

    # Move all active sink inputs (playback streams) to M-Track
    local moved_inputs=0
    while IFS= read -r input_id; do
        if [[ -n "$input_id" ]]; then
            if wpctl set-default "$input_id" "$mtrack_sink" 2>/dev/null; then
                echo "$(date): Moved sink input $input_id to M-Track sink $mtrack_sink" >> "$LOGFILE"
                ((moved_inputs++))
            else
                # Try alternative method
                if pw-cli set-param "$input_id" Props '{ target.object = "'$mtrack_sink'" }' 2>/dev/null; then
                    echo "$(date): Moved sink input $input_id to M-Track sink $mtrack_sink (alt method)" >> "$LOGFILE"
                    ((moved_inputs++))
                fi
            fi
        fi
    done < <(get_active_sink_inputs)

    # Move all active source outputs (recording streams) to M-Track (optional)
    # This behavior is controlled by MIGRATE_RECORDING_STREAMS configuration flag
    local moved_outputs=0
    if [[ "$MIGRATE_RECORDING_STREAMS" == "true" ]]; then
        if [[ -n "$mtrack_source" ]]; then
            while IFS= read -r output_id; do
                if [[ -n "$output_id" ]]; then
                    if wpctl set-default "$output_id" "$mtrack_source" 2>/dev/null; then
                        echo "$(date): Moved source output $output_id to M-Track source $mtrack_source" >> "$LOGFILE"
                        ((moved_outputs++))
                    fi
                fi
            done < <(get_active_source_outputs)
        fi
    else
        echo "$(date): Recording stream migration disabled (MIGRATE_RECORDING_STREAMS=false)" >> "$LOGFILE"
    fi

    echo "$(date): Stream migration complete: $moved_inputs sink inputs, $moved_outputs source outputs moved" >> "$LOGFILE"
    return 0
}

# Function to set M-Track as default and migrate streams
set_mtrack_default() {
    local mtrack_ids=($(get_mtrack_ids))
    local mtrack_sink=${mtrack_ids[0]}
    local mtrack_source=${mtrack_ids[1]}

    if [[ -z "$mtrack_sink" ]]; then
        echo "$(date): ERROR: Cannot find M-Track sink ID" >> "$LOGFILE"
        return 1
    fi

    # Set M-Track as default sink (output device only)
    if wpctl set-default "$mtrack_sink"; then
        echo "$(date): Set M-Track sink $mtrack_sink as default" >> "$LOGFILE"
    else
        echo "$(date): ERROR: Failed to set M-Track sink $mtrack_sink as default" >> "$LOGFILE"
        return 1
    fi

    # NOTE: Input device (source) switching removed to preserve user's preferred
    # microphone/input device (built-in mics, USB headset mics, etc.)
    # Only output device switching to M-Track is performed automatically

    # Wait a moment for the system to process the change
    sleep 1

    # Move existing streams to the new device
    move_streams_to_mtrack

    # Verify the change took effect
    if is_mtrack_default; then
        echo "$(date): Successfully switched to M-Track (verified)" >> "$LOGFILE"
        echo "$(date)" > "$STATEFILE"  # Record successful switch time
        return 0
    else
        echo "$(date): ERROR: M-Track switch verification failed" >> "$LOGFILE"
        return 1
    fi
}

# Function to check if we should avoid switching (debouncing)
should_debounce() {
    if [[ ! -f "$STATEFILE" ]]; then
        return 1  # No previous state, don't debounce
    fi

    local last_switch=$(cat "$STATEFILE" 2>/dev/null)
    if [[ -z "$last_switch" ]]; then
        return 1
    fi

    local current_time=$(date +%s)
    local last_switch_time=$(date -d "$last_switch" +%s 2>/dev/null)

    if [[ -z "$last_switch_time" ]]; then
        return 1
    fi

    local time_diff=$((current_time - last_switch_time))
    [[ $time_diff -lt $DEBOUNCE_TIME ]]
}

# Wait for system to stabilize
sleep 5

# Main monitoring loop
while true; do
    # Check if M-Track is connected via USB
    if lsusb | grep -q "$DEVICE_NAME"; then
        # Check if M-Track audio devices are available
        mtrack_ids=($(get_mtrack_ids))
        mtrack_sink=${mtrack_ids[0]}

        if [[ -n "$mtrack_sink" ]]; then
            # M-Track audio is available - check if it's the default
            if ! is_mtrack_default; then
                if ! should_debounce; then
                    echo "$(date): M-Track detected but not default, switching..." >> "$LOGFILE"
                    set_mtrack_default
                else
                    echo "$(date): M-Track switch requested but debouncing (too recent)" >> "$LOGFILE"
                fi
            fi
        else
            # M-Track USB connected but audio not available - use graduated recovery approach
            if attempt_pipewire_recovery; then
                # Recovery successful, try to set as default
                local mtrack_ids_recovered=($(get_mtrack_ids))
                if [[ -n "${mtrack_ids_recovered[0]}" ]]; then
                    echo "$(date): M-Track audio recovered, setting as default..." >> "$LOGFILE"
                    set_mtrack_default
                fi
            fi
        fi
    fi

    sleep $CHECK_INTERVAL
done
