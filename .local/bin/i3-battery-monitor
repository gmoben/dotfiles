#!/bin/bash
# Modified from https://github.com/arjvik/dots/blob/master/i3/bin/i3-battery-monitor

BATTERY="BAT0"
FULL=${3:-100}
LOW=${2:-85}
CRITICAL=${1:-5}

log() {
    echo "[pid=$$]" "$(date +"%D %I:%M:%S %p")" "$@" >> /tmp/.i3-battery-monitor-log
}

# Kill other instances of i3-battery-monitor
if pids=$(pidof -x $0 -o $$); then
    log "Killing PIDs: $pids"
    kill $pids 2>/dev/null
fi

log "Parameters: FULL=$FULL LOW=$LOW CRITICAL=$CRITICAL"

SHOULD_NOTIFY_FULL=false
# Loop indefinitely until killed
while true; do
    CHARGE=$(cat "/sys/class/power_supply/$BATTERY/capacity")
    STATUS=$(cat "/sys/class/power_supply/$BATTERY/status")
    log "$STATUS $CHARGE%"
    if [[ $STATUS == "Discharging" ]]; then

        SHOULD_NOTIFY_FULL=true
        if [[ $CHARGE -le $CRITICAL ]]; then
            log "Critical warning"
            notify-send -u critical "Battery Critical ($CHARGE%)!" "Suspending in 5 seconds..."
            log "Attempting to suspend"
            systemctl suspend-then-hibernate
        elif [[ $CHARGE -le $LOW ]]; then
            log "Low warning"
            notify-send -u normal "Battery Low ($CHARGE%)" "Plug in soon!"
        fi
    else
        if [[ $SHOULD_NOTIFY_FULL == true && $CHARGE -ge $FULL ]]; then
            log "Full warning"
            notify-send -u low "Battery Full ($CHARGE%)"
            SHOULD_NOTIFY_FULL=false
        fi
    fi
    sleep 30s
done
